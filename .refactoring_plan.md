# Refactoring Plan (2026-02-09)

Temporary file — delete after refactoring is complete.

Each phase ends with a working codebase (runnable, no import errors).
Order: Phase 1 → 2 → 3 → 4 → 5 → 6 (strict).

---

## Phase 1: h2_helpers.py (foundation)

1. Import reorder — stdlib (`glob`, `re`, `os`, `itertools.combinations`) to
   stdlib block, isort order
2. Type hints — remove `from typing import List, Optional, Sequence, Tuple`,
   use `tuple[...]`, `list[...]`, `X | None` (keep `Any`)
3. `__all__` — cover all public symbols
4. Docstrings — `_find_lowest_det_occupation`, `_build_h2_force_operator`,
   `parse_log_files` → English Google style with Args/Returns
5. `logging` — add `logger = logging.getLogger(__name__)`, replace `print()`
   in `parse_log_files` with `logger.info` / `logger.warning`

Verify: all scripts still import from h2_helpers without error.

---

## Phase 2: h2_energy.py, h2_energy_statevector.py

1. Remove `compute_h2_energy_classical` from h2_energy.py (import from
   h2_helpers instead). Fix re-import chains in h2_energy_demo.py.
2. Import reorder, unused import removal
3. Type hints → built-in lowercase + PEP 604
4. `eval_chache` → `eval_cache` (both files)
5. `__all__`
6. `logging` — replace progress `print()` with `logger.*`, keep manual
   `open/write` for VQE trace files
7. Docstrings — English Google style

Verify: `python h2_energy_demo.py` runs VQE as before.

---

## Phase 3: h2_energy_demo.py + NEW h2_dynamics.py

1. Create `h2_dynamics.py` — move MD logic from h2_energy_demo.py:
   `velocity_verlet`, `dynamics_seq`, `compute_energy_angstrom`,
   `compute_force_angstrom`, `compute_force_angstrom_classical`,
   worker functions. New file follows all conventions from the start.
2. Slim down h2_energy_demo.py — `from h2_dynamics import ...`
3. Import cleanup — remove `typing.Dict/List/Tuple/Union/Callable`, unused
   imports (`QiskitRuntimeService`, `NoiseModel`, `depolarizing_error`), isort
4. Remove duplicate unit-conversion constants (`bohr`, `angstrom`, `mu`,
   `T_au_fs`) — use h2_helpers constants directly
5. `logging` in `main()` — `logging.basicConfig()`, log experiment params
6. `__all__`, docstrings
7. Update copilot-instructions.md module structure to include `h2_dynamics.py`

Verify: `python h2_energy_demo.py` runs MD + force-curve comparison as before.

---

## Phase 4: h2_energy_distribution.py

1. `from __future__ import annotations`
2. Import reorder (isort)
3. Entry-point pattern — `main()` + `if __name__ == "__main__": main()`,
   separate `parse_args()`
4. `__all__`, `logging`, docstrings

Verify: `python h2_energy_distribution.py` runs as before.

---

## Phase 5: plot_energy_vs_distance.py, plot_force_from_log.py, read_csv.py

1. Entry-point pattern — all 3 files get `main()` + guard, `parse_args()`
2. `from __future__ import annotations` (all 3)
3. Move computation logic to h2_dynamics.py:
   - plot_energy_vs_distance.py: `numerical_force`, `dynamics_simulation`
   - read_csv.py: `compute_kinetic_energy`, `run_classical_dynamics`
4. Delete Morse fitting — `morse_potential`, `morse_force`, fitting logic,
   related plots from plot_energy_vs_distance.py
5. Hardcoded timestamps → CLI `--log-dir` argument
6. Remove unnecessary `try/except` wrapping library calls
7. Move plot code from h2_energy_demo.py `compare_force_curves` behind
   `--plot` flag or to visualization script
8. `__all__`, `logging`, docstrings

Verify: `python plot_energy_vs_distance.py --log-dir logs/2511301524`,
        `python plot_force_from_log.py`, `python read_csv.py`

---

## Phase 6: vqe_h2.py, vqe_LiH.py

1. `from __future__ import annotations`
2. All imports to top, isort order (eliminate mid-script imports)
3. Entry-point pattern — `main()` + guard
4. Remove hardcoded backend name `"ibm_kawasaki"` → env var
5. `__all__`, `logging`, docstrings

Verify: `python vqe_h2.py --backend <name>` (no import errors at minimum).

---

## New file: h2_dynamics.py

Responsibilities (accumulated across Phase 3 and Phase 5):
- `velocity_verlet` — Velocity Verlet integrator
- `dynamics_seq` — sequential VQE-force MD simulation (CSV output)
- `compute_energy_angstrom` / `compute_force_angstrom` /
  `compute_force_angstrom_classical` — Å-unit wrappers
- `run_classical_dynamics` — classical (Full CI) MD simulation
- `compute_kinetic_energy` — kinetic energy calculation
- `numerical_force` — numerical differentiation for force
